<h1 id="0654" class="dn bg do dp b dq dr ds dt du dv dw dx dy dz ea eb ec ed ee ef eg eh ei ej ek ci">Docker Tutorial Series : Writing a Dockerfile</h1>
<div class="n fx fy fz ga gb gc gd ge z">&nbsp;</div>
<p id="662b" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">In this part, we shall take a look at how to build our own Docker images via a Dockerfile. We saw building our own image earlier via running a Container, installing our software and doing a commit to create the image in However, writing a Dockerfile is a more consistent and repeatable way to build your own images.</p>
<p id="e894" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">A Dockerfile is a text file that has a series of instructions on how to build your image. It supports a simple set of commands that you need to use in your Dockerfile. There are several commands supported like FROM, CMD, ENTRYPOINT, VOLUME, ENV and more. We shall look at some of them.</p>
<p id="83b3" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">Let us first start with the the overall flow, which goes something like this:</p>
<ol class="">
<li id="c8e6" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi hk hl hm ci">You create a Dockerfile with the required instructions.</li>
<li id="5b10" class="gl gm do gn b go hn gq gr gs ho gu gv gw hp gy gz ha hq hc hd he hr hg hh hi hk hl hm ci">Then you will use the docker build command to create a Docker image based on the Dockerfile that you created in step 1.</li>
</ol>
<p id="71b7" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">With this information, let us get going.</p>
<p id="ffaf" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">First up, launch boot2docker and create a folder named images as shown below. This will be our root folder where we will create our Dockerfile.</p>
<pre class="hs ht hu hv hw hx hy co"><span id="d679" class="ci hz ia do ib b ic id ie s if">docker@boot2docker:~$ mkdir images</span></pre>
<p id="cac3" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">Then we navigate into that directory via cd images.</p>
<p id="accb" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">Now, open up the vi editor and create our first Dockerfile as shown below:</p>
<pre class="hs ht hu hv hw hx hy co"><span id="ba65" class="ci hz ia do ib b ic id ie s if">FROM busybox:latest<br />MAINTAINER Romin Irani (email@domain.com)</span></pre>
<p id="be89" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">Since, a Docker image is nothing but a series of layers built on top of each other, we start with a base image. The <a class="ez hj" href="https://docs.docker.com/reference/builder/#from" rel="noopener">FROM </a>command sets the base image for the rest of the instructions. The MAINTAINER command tells who is the author of the generated images. This is a good practice. You could have taken any other base image in the FROM instruction too, for e.g. ubuntu:latest or ubunt:14.04, etc.</p>
<p id="999d" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">Now, save the file and come back to the prompt.</p>
<p id="6a4f" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">Execute the following in the <strong class="gn ig">/images</strong> folder as shown below:</p>
<pre class="hs ht hu hv hw hx hy co"><span id="7235" class="ci hz ia do ib b ic id ie s if">$ docker build -t myimage:latest .<br /> Sending build context to Docker daemon 2.048 kB<br /> Sending build context to Docker daemon<br /> Step 0 : FROM busybox:latest<br /> ---&gt; 8c2e06607696<br /> Step 1 : MAINTAINER Romin Irani (email@domain.com)<br /> ---&gt; Running in 5d70f02a83e1<br /> ---&gt; 3bc3545a1f64<br /> Removing intermediate container 5d70f02a83e1<br /> Successfully built 3bc3545a1f64<br />$</span></pre>
<p id="ae05" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">What we have done here is the step 2 that we highlighted in the overall process above i.e. we have executed the docker build command. This command is used to build a Docker image. The parameters that we have passed are:</p>
<ul class="">
<li id="4392" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi ih hl hm ci">-t is the Docker image tag. You can give a name to your image and a tag.</li>
<li id="de2d" class="gl gm do gn b go hn gq gr gs ho gu gv gw hp gy gz ha hq hc hd he hr hg hh hi ih hl hm ci">The second parameter (a &lsquo;.&rsquo;) specifies the location of the Dockerfile that we created. Since we created the Dockerfile in the same folder in which we are running the docker build, we specified the current directory.</li>
</ul>
<p id="1e5b" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">Notice the various steps that the build process goes through to build out your image.</p>
<p id="e3cc" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">If you run a docker images command now, you will see the myimage image listed in the output as shown below:</p>
<pre class="hs ht hu hv hw hx hy co"><span id="b201" class="ci hz ia do ib b ic id ie s if">$ docker images<br />REPOSITORY TAG    IMAGE ID     CREATED       VIRTUAL SIZE<br />myimage    latest 3bc3545a1f64 3 minutes ago 2.433 MB</span></pre>
<p id="0119" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">You can now launch a container, any time via the standard docker run command:</p>
<pre class="hs ht hu hv hw hx hy co"><span id="7fb7" class="ci hz ia do ib b ic id ie s if">$ docker run -it myimage<br />/ #</span></pre>
<p id="eaee" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">And we are back into the <strong class="gn ig">myimage</strong> shell.</p>
<p id="6fd4" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">Now, let us modify the Dockerfile with a new instruction <a class="ez hj" href="https://docs.docker.com/reference/builder/#cmd" rel="noopener">CMD </a>as shown below:</p>
<pre class="hs ht hu hv hw hx hy co"><span id="45bb" class="ci hz ia do ib b ic id ie s if">FROM busybox:latest<br />MAINTAINER Romin Irani (email@domain.com)<br />CMD ["date"]</span></pre>
<p id="d2ba" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">Now, build the image and run a container based on it again. You will find that it printed out the date for you as shown below:</p>
<pre class="hs ht hu hv hw hx hy co"><span id="da0a" class="ci hz ia do ib b ic id ie s if">$ docker run -it myimage<br />Thu Dec 14 11:14:42 UTC 2017</span></pre>
<p id="a644" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">The CMD instruction takes various forms and when it is used individually in the file without the ENTRYPOINT command (which we will see in a while), it takes the following format:</p>
<pre class="hs ht hu hv hw hx hy co"><span id="8ba2" class="ci hz ia do ib b ic id ie s if">CMD ["executable","param1","param2"]</span></pre>
<p id="795a" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">So in our case, we provided the date command as the executable and when we ran a container based on the myimage now, it printed out the data.</p>
<p id="e716" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">In fact, while launching the container, you can override the default CMD by providing it at the command line as shown below. In this example, we are saying to launch the shell , thereby overriding the default CMD instruction for the Docker Image. Notice that it will lead us into the shell.</p>
<pre class="hs ht hu hv hw hx hy co"><span id="70d6" class="ci hz ia do ib b ic id ie s if">$ docker run -it myimage /bin/sh<br />/ #</span></pre>
<p id="3f87" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">Exercise: Try out modifying the CMD instruction. Give some other commands like CMD [&ldquo;ls&rdquo;,&rdquo;-al&rdquo;] , build the image and run a container based on that. The best practice is to use another command <a class="ez hj" href="https://docs.docker.com/reference/builder/#entrypoint" rel="noopener">ENTRYPOINT</a> together with CMD. The ENTRYPOINT is used to specify the default app that you want to run (This is the way to configure a container that will run as an executable.) The CMD will then provide only the list of parameters to that ENTRYPOINT application. You could still override the CMD parameters at the command line while launching the container. Let us understand that with the following example.</p>
<p id="3f53" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">Change your Dockerfile to the following:</p>
<pre class="hs ht hu hv hw hx hy co"><span id="2b10" class="ci hz ia do ib b ic id ie s if">FROM busybox<br /><br />ENTRYPOINT [&ldquo;/bin/cat&rdquo;]<br />CMD [&ldquo;/etc/passwd&rdquo;]</span></pre>
<p id="ddeb" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">Now when you build the image and run a container as follows:</p>
<pre class="hs ht hu hv hw hx hy co"><span id="27b6" class="ci hz ia do ib b ic id ie s if">$ docker run -it myimage<br /> root:x:0:0:root:/root:/bin/sh<br /> daemon:x:1:1:daemon:/usr/sbin:/bin/sh<br /> bin:x:2:2:bin:/bin:/bin/sh<br /> sys:x:3:3:sys:/dev:/bin/sh<br /> sync:x:4:100:sync:/bin:/bin/sync<br /> mail:x:8:8:mail:/var/spool/mail:/bin/sh<br /> proxy:x:13:13:proxy:/bin:/bin/sh<br /> www-data:x:33:33:www-data:/var/www:/bin/sh<br /> backup:x:34:34:backup:/var/backups:/bin/sh<br /> operator:x:37:37:Operator:/var:/bin/sh<br /> haldaemon:x:68:68:hald:/:/bin/sh<br /> dbus:x:81:81:dbus:/var/run/dbus:/bin/sh<br /> ftp:x:83:83:ftp:/home/ftp:/bin/sh<br /> nobody:x:99:99:nobody:/home:/bin/sh<br /> sshd:x:103:99:Operator:/var:/bin/sh<br /> default:x:1000:1000:Default non-root user:/home/default:/bin/sh</span></pre>
<p id="cad4" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">So, what happened what it took the default ENTRYPOINT i.e. cat command and used the parameters that the CMD provided to run the command.</p>
<p id="2a04" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">Try to override the CMD by running the container with a non-existent file name:</p>
<pre class="hs ht hu hv hw hx hy co"><span id="5d85" class="ci hz ia do ib b ic id ie s if">$ docker run -it myimage somefile.txt<br /> cat: can't open 'somefile.txt': No such file or directory</span></pre>
<p id="98b5" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">You get the point?</p>
<p id="3580" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">Now, let us look at another Dockerfile shown below:</p>
<pre class="hs ht hu hv hw hx hy co"><span id="a402" class="ci hz ia do ib b ic id ie s if">FROM ubuntu RUN apt-get update<br />RUN apt-get install -y nginx<br />ENTRYPOINT [&ldquo;/usr/sbin/nginx&rdquo;,&rdquo;-g&rdquo;,&rdquo;daemon off;&rdquo;]<br />EXPOSE 80</span></pre>
<p id="2a02" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">Here, what we are building is an image that will run the nginx proxy server for us. Look at the set of instructions and it should be pretty clear. After the standard FROM and MAINTAINER instructions, we are executing a couple of RUN instructions. A <a class="ez hj" href="https://docs.docker.com/reference/builder/#run" rel="noopener">RUN</a> instruction is used to execute any commands. In this case we are running a package update and then installing nginx. The ENTRYPOINT is then running the nginx executable and we are using the EXPOSE command here to inform what port the container will be listening on. Remember in our earlier chapters, we saw that if we use the -P command, then the EXPOSE port will be used by default. However, you can always change the host port via the -p parameter as needed.</p>
<p id="56b8" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">If you build the image and run the container as follows:</p>
<pre class="hs ht hu hv hw hx hy co"><span id="9e9e" class="ci hz ia do ib b ic id ie s if">docker run -d -p 80:80 --name webserver myimage</span></pre>
<p id="73bf" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">You will find that it will have nginx started on port 80. And if you visit the page via the host IP, you will see the following point:</p>
<figure class="hs ht hu hv hw ii cz da paragraph-image">
<div class="n p cc"><img class="ij" src="https://miro.medium.com/proxy/0*AqV1QSYrgQfOnauz.png" alt="nginx1" /></div>
</figure>
<p id="199e" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">Now, how about adding your own pages into the nginx server instead of the default page.</p>
<p id="3f2a" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">So, let&rsquo;s say that you were in the images folder still and have the Dockerfile present over there. Create an index.html file over there with just some simple text like &lt;h1&gt;Hello Docker&lt;/h1&gt;</p>
<p id="a718" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">The updated Dockerfile is shown below:</p>
<pre class="hs ht hu hv hw hx hy co"><span id="6db0" class="ci hz ia do ib b ic id ie s if">FROM ubuntu<br />MAINTAINER<br />RUN apt-get update<br />RUN apt-get install -y nginx<br />COPY index.html /usr/share/nginx/html/<br />ENTRYPOINT [&ldquo;/usr/sbin/nginx&rdquo;,&rdquo;-g&rdquo;,&rdquo;daemon off;&rdquo;]<br />EXPOSE 80</span></pre>
<p id="6f98" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">Notice a new command COPY. This will copy the files/folders from the source to the destination in the container. On building and running this container, you will see your default page. Learn about the <a class="ez hj" href="https://docs.docker.com/reference/builder/#add" rel="noopener">ADD</a> instruction too.</p>
<p id="a17c" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">Using these commands now, it should be clear to you how you can now begin to package Docker images with your software. Just think in terms of all the steps that you would normally do to install and run your software.</p>
<p id="b069" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi dh ci">There is a lot more to writing Dockerfiles and I suggest that via this part, you have understood the basics of writing them. The best way is to jump into writing a file, playing with the commands and using some of the best practices (an article which I have referenced in the Additional Reading section).</p>
<h2 id="af8b" class="hz ia do av aw ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je ci">Additional Reading</h2>
<p id="a042" class="gl gm do gn b go jf gq gr gs jg gu gv gw jh gy gz ha ji hc hd he jj hg hh hi dh ci">There are plenty of resources on writing Dockerfiles. Here are 3 that you should go through:</p>
<ul class="">
<li id="18a7" class="gl gm do gn b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi ih hl hm ci"><a class="ez hj" href="https://docs.docker.com/reference/builder/" rel="noopener">Official documentation</a> as a reference to understand any command. You should go through this.</li>
<li id="6dd9" class="gl gm do gn b go hn gq gr gs ho gu gv gw hp gy gz ha hq hc hd he hr hg hh hi ih hl hm ci"><a class="ez hj" href="https://docs.docker.com/articles/dockerfile_best-practices/" rel="noopener">Best Practices</a> article on writing Docker files that I recommend.</li>
</ul>
